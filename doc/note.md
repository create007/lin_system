# 准备

### 软件环境

```console
apt install nasm
apt install bochs
```
### 过程命令

nasm -f bin boot.asm -o boot.bin

### 创建硬盘镜像

bximage -q -hd=16 -func=create -sectsize=512 -imgmode=flat master.img

将boot.bin 写入主引导扇区

    dd if=boot.bin of=master.img bs=512 count=1 conv=notrunc

### 配置bochs

ata0-master: type=disk, path="master.img", mode=flat

```
# configuration file generated by Bochs
plugin_ctrl: unmapped=1, biosdev=1, speaker=1, extfpuirq=1, iodebug=1, ioapic=1
config_interface: textconfig
display_library: x, options="gui_debug"
memory: host=32, guest=32
romimage: file="/usr/local/share/bochs/BIOS-bochs-latest"
vgaromimage: file="/usr/local/share/bochs/VGABIOS-lgpl-latest"
boot: disk
floppy_bootsig_check: disabled=0
# no floppya
# no floppyb
ata0-master: type=disk, path="master.img", mode=flat
ata1: enabled=1, ioaddr1=0x170, ioaddr2=0x370, irq=15
ata2: enabled=0
ata3: enabled=0
parport1: enabled=1, file=""
parport2: enabled=0
com1: enabled=1, mode=null, dev=""
com2: enabled=0
com3: enabled=0
com4: enabled=0
usb_uhci: enabled=0
usb_ohci: enabled=0
i440fxsupport: enabled=0
vga_update_interval: 50000
vga: extension=vbe
cpu: count=1, ips=4000000, reset_on_triple_fault=1, ignore_bad_msrs=1
cpuid: cpuid_limit_winnt=0, mmx=1, sse=sse2, xapic=1, sep=1, aes=0, xsave=0, movbe=0
print_timestamps: enabled=0
debugger_log: -
magic_break: enabled=0
port_e9_hack: enabled=0
text_snapshot_check: enabled=0
private_colormap: enabled=0
clock: sync=none, time0=local
# no cmosimage
ne2k: enabled=0
pnic: enabled=0
sb16: enabled=0
# no loader
log: -
logprefix: %t%e%d
panic: action=ask
error: action=report
info: action=report
debug: action=ignore
pass: action=fatal
keyboard_type: mf
keyboard_serial_delay: 250
keyboard_paste_delay: 100000
keyboard_mapping: enabled=0, map=
user_shortcut: keys=none
mouse: enabled=0, type=ps2

```

## 主引导扇区 

### BIOS

Basic Input Output System

BIOS 在上电自检主引导扇区读0x7c00位置，并跳转执行

### 实模式

8086模式，16位， 保护模式

```s
; 0xb8000 文本显示器的内存区域
mov ax, 0xb800
mov ds, ax
mov byte [0], 'H'
```

### 实模式寻址方式

> 有效地址 = 段地址 * 16 + 偏移地址
> EA = 0xb800 * 0x10 + 0

### 主引导扇区结构

- 总共有512B
- 代码: 446B
- 硬盘分区表: 64B, 可以分为4个分区
- 模数: 0xaa55, 或者0x55 0xaa

### 主引导扇区功能

读取内核加载器并执行

## 在U盘启动

格式化U盘
- sudo fdisk /dev/sdb1

usb:

- sudo dd if=/dev/sdb1 of=tmp.bin bs=512 count=1 conv=notrunc
- cp tmp.bin usb.bin 
- sudo rm tmp.bin


## 实模式 printf

- ah: 0x0e
- al: 字符
- int 0x10


## 硬盘读写

- 扇区：硬盘读写最小单位，最小一个扇区，最多256个扇区。
- 机械硬盘，机械臂的寻道时间时硬盘性能的主要瓶颈。
- 磁盘从外侧计数，所以C盘数据一般存储在外侧磁道。
  
### IDE / ATA

Port Input Output 端口输入输出模式

端口是外部设备内部寄存器

- IDE: Integration Drive Electronics 集成电子驱动器
- ATA：Advanced Technology Attachment

### 硬盘读写模式

- CHS模式  Cylinder HEAD sector
- LBA模式 logical block address

LBA28，能访问128G磁盘空间

硬盘控制端口

| primary通道  |  Secondary 通道 | in操作 | out操作 |
|--------| ------| -------|-------|
| 0x1F0 | 0x170 | Data | Data|
| 0x1F1 | 0x171 | Error | features |
| 0x1F2 | 0x172 | Sector count | sector count |
| 0x1F3 | 0x173 | LBA low | LBA low |
| 0x1F4 | 0x174 | LBA mid | LBA mid |
| 0x1F5 | 0x175 | LBA high | LBA high |
| 0x1F6 | 0x176 | Device | Device|
| 0x1F7 | 0x177 | Status | Command |

- 0X1F0: 16bit 端口，用于读写数据
- 0X1F1: 检测前一个指令的错误
- 0X1F2: 读写扇区的数量
- 0X1F3: 起始扇区0-7位
- 0X1F4: 起始扇区8-15位
- 0X1F5: 起始扇区16-23位
- 0X1F6: 
  - 0~3: 起始扇区24-27位
  - 4: 0 主盘 1 从盘
  - 6: 0 CHS 1 LBA
  - 5 / 7: 固定为1
- 0X1F7: out
  - 0XEC: 识别硬盘
  - 0X20: 读硬盘
  - 0X30: 写硬盘
- 0X1F7: in
  - 0: ERR
  - 3 DRQ 数据准备完毕
  - 7 BSY 硬盘繁忙

















## 参考书籍

《操作系统真象还原》




